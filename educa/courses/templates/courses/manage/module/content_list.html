{% extends "base.html" %}
{% load course %}
{% load static %}

{% block title %}
  Module {{ module.order|add:1 }}: {{ module.title }} | Educa
{% endblock %}

{% block content %}
{% with course=module.course %}
<div class="courses-container">
  <div class="courses-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-book"></i>
        {{ course.title }}
      </h1>
      <p class="page-subtitle">Manage course content and module structure</p>
    </div>
    <div class="header-actions">
      <a href="{% url 'manage_course_list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Courses</span>
      </a>
    </div>
  </div>

  <div class="module-management">
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>
          <i class="fas fa-layer-group"></i>
          Course Modules
        </h3>
        <p class="sidebar-subtitle">Select a module to manage its content</p>
      </div>
      
      <ul class="module-list" id="modules">
        {% for m in course.modules.all %}
        <li class="module-item {% if m == module %}active{% endif %}" data-id="{{ m.id }}">
          <div class="module-item-content">
            <div class="module-info">
              <a href="{% url 'module_content_list' m.id %}" class="module-link">
                <div class="module-order">
                  <span class="order-badge order">{{ m.order|add:1 }}</span>                </div>
                <div class="module-details">
                  <h4 class="module-title">{{ m.title|default:"Untitled Module" }}</h4>
                  <div class="module-meta">
                    <span class="meta-item">
                      <i class="fas fa-file-alt"></i>
                      {{ m.contents.count }} content{{ m.contents.count|pluralize }}
                    </span>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </li>
        {% empty %}
        <li class="empty-modules">
          <div class="empty-state-small">
            <i class="fas fa-inbox"></i>
            <p>No modules yet</p>
          </div>
        </li>
        {% endfor %}
      </ul>
      
      <div class="sidebar-actions">
        <a href="{% url 'course_module_update' course.id %}" class="btn btn-secondary btn-sm">
          <i class="fas fa-edit"></i>
          <span>Edit Modules</span>
        </a>
      </div>
    </div>

    <div class="content-area">
      <div class="module-header-card">
        <div class="module-header-content">
          <div class="module-badge">
            <span class="badge-number">{{ module.order|add:1 }}</span>
          </div>
          <div class="module-header-info">
            <h2>{{ module.title|default:"Untitled Module" }}</h2>
            <p class="module-description">{{ module.description|default:"No description provided" }}</p>
          </div>
        </div>
        <div class="module-header-stats">
          <div class="stat-item">
            <i class="fas fa-file-alt"></i>
            <span>{{ module.contents.count }} content{{ module.contents.count|pluralize }}</span>
          </div>
        </div>
      </div>

      <div class="contents-card">
        <div class="contents-header">
          <h3>
            <i class="fas fa-file-alt"></i>
            Module Contents
          </h3>
          <p class="contents-subtitle">Manage your module contents</p>
        </div>
        
        <div class="contents-list" id="module-contents">
          {% for content in module.contents.all %}
          <div class="content-item" data-id="{{ content.id }}">
            <div class="content-item-header">
              <div class="content-drag-handle">
                <i class="fas fa-grip-vertical"></i>
              </div>
              <div class="content-type-icon">
                {% with item=content.item %}
                  {% if item|model_name == "text" %}
                    <i class="fas fa-font"></i>
                  {% elif item|model_name == "image" %}
                    <i class="fas fa-image"></i>
                  {% elif item|model_name == "video" %}
                    <i class="fas fa-video"></i>
                  {% elif item|model_name == "file" %}
                    <i class="fas fa-file"></i>
                  {% else %}
                    <i class="fas fa-file-alt"></i>
                  {% endif %}
                {% endwith %}
              </div>
              <div class="content-info">
                <h4 class="content-title">
                  {% with item=content.item %}
                    {{ item.title|default:item|model_name|title }}
                  {% endwith %}
                </h4>
                <p class="content-type">
                  {% with item=content.item %}
                    {{ item|model_name|title }} content
                  {% endwith %}
                </p>
              </div>
            </div>
            
            <div class="content-actions">
              {% with item=content.item %}
              <a href="{% url 'module_content_update' module.id item|model_name item.id %}" class="btn-action btn-edit" title="Edit">
                <i class="fas fa-edit"></i>
                <span>Edit</span>
              </a>
              <form action="{% url 'module_content_delete' content.id %}" method="post" class="delete-form-inline">
                {% csrf_token %}
                <button type="submit" class="btn-action btn-delete" title="Delete">
                  <i class="fas fa-trash-alt"></i>
                  <span>Delete</span>
                </button>
              </form>
              {% endwith %}
            </div>
          </div>
          {% empty %}
          <div class="empty-contents">
            <div class="empty-state-medium">
              <i class="fas fa-file-alt"></i>
              <h4>No contents yet</h4>
              <p>Add content to this module to get started</p>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="add-content-section">
          <h3>
            <i class="fas fa-plus-circle"></i>
            Add New Content
          </h3>
          <p class="add-content-subtitle">Select content type to add</p>
          
          <div class="content-type-grid">
            <a href="{% url 'module_content_create' module.id 'text' %}" class="content-type-card">
              <div class="content-type-icon-large">
                <i class="fas fa-font"></i>
              </div>
              <h4>Text</h4>
              <p>Add formatted text content</p>
            </a>
            
            <a href="{% url 'module_content_create' module.id 'image' %}" class="content-type-card">
              <div class="content-type-icon-large">
                <i class="fas fa-image"></i>
              </div>
              <h4>Image</h4>
              <p>Upload images with descriptions</p>
            </a>
            
            <a href="{% url 'module_content_create' module.id 'video' %}" class="content-type-card">
              <div class="content-type-icon-large">
                <i class="fas fa-video"></i>
              </div>
              <h4>Video</h4>
              <p>Add video content or links</p>
            </a>
            
            <a href="{% url 'module_content_create' module.id 'file' %}" class="content-type-card">
              <div class="content-type-icon-large">
                <i class="fas fa-file"></i>
              </div>
              <h4>File</h4>
              <p>Upload documents and files</p>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endwith %}
{% endblock %}

{% block include_js %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5sortable/0.13.3/html5sortable.min.js"></script>
{% endblock %}

{% block domready %}
  var options = {
      method: 'POST',
      mode: 'same-origin'
  }

  const moduleOrderUrl = '{% url "module_order" %}';

  sortable('#modules', {
    forcePlaceholderSize: true,
    placeholderClass: 'placeholder'
  })[0].addEventListener('sortupdate', function(e) {

    modulesOrder = {};
    var modules = document.querySelectorAll('#modules li');
    modules.forEach(function (module, index) {
      // update module index
      modulesOrder[module.dataset.id] = index;
      // update index in HTML element
      module.querySelector('.order').innerHTML = index + 1;
    });

    // add new order to the HTTP request options
    options['body'] = JSON.stringify(modulesOrder);

    // send HTTP request
    fetch(moduleOrderUrl, options)
  });

  const contentOrderUrl = '{% url "content_order" %}';

  sortable('#module-contents', {
    forcePlaceholderSize: true,
    placeholderClass: 'placeholder'
  })[0].addEventListener('sortupdate', function(e) {

    contentOrder = {};
    var contents = document.querySelectorAll('#module-contents div');
    contents.forEach(function (content, index) {
      // update content index
      contentOrder[content.dataset.id] = index;
    });

    // add new order to the HTTP request options
    options['body'] = JSON.stringify(contentOrder);

    // send HTTP request
    fetch(contentOrderUrl, options)
  });

{% endblock %}